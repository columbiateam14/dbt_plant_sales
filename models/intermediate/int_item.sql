WITH ITEM_AGG_TABLE AS (
    WITH ITEM_TABLE AS (
        SELECT 
            ii.ITEM_NAME,
            ii.PRICE_PER_UNIT,
            ii.SESSION_ID,
            os.DID_ORDER,
            COALESCE(SUM(ii.ADD_TO_CART_QUANTITY), 0) AS TOTAL_ADDED_TO_CART,
            COALESCE(SUM(ii.REMOVE_FROM_CART_QUANTITY), 0) AS TOTAL_REMOVED_FROM_CART
        FROM {{ ref('base_snowflake__item_views') }} AS ii
        LEFT JOIN {{ ref('int_session') }} AS os 
        ON ii.SESSION_ID = os.SESSION_ID
        GROUP BY ii.ITEM_NAME, ii.PRICE_PER_UNIT, ii.SESSION_ID, os.DID_ORDER
        ORDER BY ii.SESSION_ID
    )
    
    SELECT 
        ITEM_NAME,
        PRICE_PER_UNIT,
        SESSION_ID,
        DID_ORDER,
        TOTAL_ADDED_TO_CART,
        TOTAL_REMOVED_FROM_CART,
        CASE WHEN DID_ORDER = 1 THEN TOTAL_ADDED_TO_CART - TOTAL_REMOVED_FROM_CART ELSE 0 END AS TOTAL_QUANTITY_ORDERED,
        CASE WHEN DID_ORDER = 1 THEN TOTAL_QUANTITY_ORDERED*PRICE_PER_UNIT ELSE 0 END AS TOTAL_PLANT_PROFIT
    FROM ITEM_TABLE AS it
    ORDER BY DID_ORDER DESC, SESSION_ID
)
SELECT 
    ITEM_NAME,
    PRICE_PER_UNIT,
    COALESCE(SUM(TOTAL_ADDED_TO_CART), 0) AS TOTAL_ADDED_TO_CART, 
    COALESCE(SUM(TOTAL_REMOVED_FROM_CART), 0) AS TOTAL_REMOVED_FROM_CART,
    COALESCE(SUM(TOTAL_QUANTITY_ORDERED), 0) AS TOTAL_QUANTITY_ORDERED,
    COALESCE(SUM(TOTAL_PLANT_PROFIT), 0) AS TOTAL_PLANT_PROFIT
FROM ITEM_AGG_TABLE
GROUP BY ITEM_NAME,PRICE_PER_UNIT