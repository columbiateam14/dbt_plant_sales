WITH DAILY_EXPENSE AS (
    SELECT
        DATE(ES.DATE) AS FINANCE_DATE,
        SUM(EXPENSE_AMOUNT) AS DAILY_TOTAL_EXPENSE
    FROM {{ ref('base_google_drive__expenses') }} AS ES
    GROUP BY DATE
    ORDER BY DATE
), DAILY_REVENUE AS (
    SELECT 
      DATE(DATE_TRUNC('DAY', ORDER_AT_TS)) AS DATE,
      SUM(PRICE_PER_QUANTITY) AS DAILY_TOTAL_REVENUE
    FROM {{ ref('int_order_summary') }}  AS OS
    GROUP BY DATE
    ORDER BY DATE
), DAILY_REFUND AS (
    SELECT 
      DATE(DATE_TRUNC('DAY', RETURNED_DATE)) AS DATE,
      SUM(CASE WHEN IS_REFUNDED = 'yes' THEN PRICE_PER_UNIT ELSE 0 END) AS DAILY_TOTAL_REFUND
    FROM {{ ref('int_order_summary') }} AS OS
    GROUP BY DATE
    ORDER BY DATE
)

SELECT FINANCE_DATE,
       DAILY_TOTAL_REVENUE,
       DAILY_TOTAL_EXPENSE,
       DAILY_TOTAL_REFUND,
       CASE 
        WHEN DAILY_TOTAL_REFUND IS NULL THEN DAILY_TOTAL_REVENUE - DAILY_TOTAL_EXPENSE 
        ELSE DAILY_TOTAL_REVENUE - DAILY_TOTAL_EXPENSE - DAILY_TOTAL_REFUND END AS DAILY_TOTAL_PROFIT
FROM DAILY_REVENUE AS DR
INNER JOIN DAILY_EXPENSE AS DE
ON FINANCE_DATE = DR.DATE
LEFT JOIN DAILY_REFUND AS DF
ON FINANCE_DATE = DF.DATE
ORDER BY FINANCE_DATE